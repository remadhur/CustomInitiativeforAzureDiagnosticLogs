{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "builtinpolicies": {
        "value": [
          {
            "name" :"diagnosticsetting4c0eae03",
            "remediation" : true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/d56a5a7c-72d7-42bc-8ceb-3baf4c0eae03",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }
          },
          {
            "name" :"diagnosticsetting4c0e234",
            "remediation" : true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/f8352124-56fa-4f94-9441-425109cdc14b",
            "parameters": {
              "logAnalytics": {
                "value":  "<log analytics id for diagnostics>"
              },
              "diagnosticSettingName": {
                "value":  "StreamLogsToCentralLAW"
              },
              "categoryGroup": {
                "value":  "allLogs"
              }
            }
          },
          {
            "name" :"diagnosticsetting4c0e456",
            "remediation" : true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/56288eb2-4350-461d-9ece-2bb242269dce",
            "parameters": {
              "logAnalytics": {
                "value":  "<log analytics id for diagnostics>"
              },
              "diagnosticSettingName": {
                "value":  "StreamLogsToCentralLAW"
              },
              "categoryGroup": {
                "value":  "allLogs"
              }
            }
          },
          {
            "name" :"diagnosticsettingef4c47",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bef3f64c-5290-43b7-85b0-9b254eef4c47",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }
          },
          {
            "name" :"diagnosticsettingedab9b",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/c84e5349-db6d-4769-805e-e14037dab9b5",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }
          },
          {
            "name" :"diagnosticsettingc81fb3",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/c717fb0c-d118-4c43-ab3d-ece30ac81fb3",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                }
            }            
          },
          {
            "name" :"diagnosticsettinge18721",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/b889a06c-ec72-4b03-910a-cb169ee18721",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }            
          },
          {
            "name" :"diagnosticsettingd79c7d",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/08ba64b8-738f-4918-9686-730d2ed79c7d",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }
          },
          {
            "name" :"diagnosticsetting80b55e",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/04d53d87-841c-4f23-8a5b-21564380b55e",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }
          },
          {
            "name" :"diagnosticsettinga42579",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/1f6e93e8-6b31-41b1-83f6-36e449a42579",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }
          },
          {
            "name" :"diagnosticsetting0a39b",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/98a2e215-5382-489e-bd29-32e7190a39ba",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "diagnosticsSettingNameToUse": {
                    "value":  "StreamLogsToCentralLAW"
                }
            }
          },
          {
            "name" :"diagnosticsetting3eb74b",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/25763a0a-5783-4f14-969e-79d4933eb74b",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }
          },
          {
            "name" :"diagnosticsetting66d673",
            "remediation" :true,
            "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/237e0f7e-b0e8-4ec4-ad46-8c12cb66d673",
            "parameters": {
                "logAnalytics": {
                    "value":  "<log analytics id for diagnostics>"
                },
                "profileName": {
                    "value":  "StreamLogsToCentralLAW"
                },
                "metricsEnabled": {
                    "value":  "True"
                },
                "logsEnabled": {
                    "value":  "True"
                }
            }
          }   
        ]
      },
      "custompolicies": {
        "value": [ 
            {
                "name": "Deny_Delete_Diag",
                "remediation" : false,
                "description": "Policy to prevent Diagnostics deletion",
                "displayName": "Deny-Delete Diagnostics Settings if Created by Core or  teams",
                "policyRule": {
                    "if": {
                        "allOf": [
                          {
                            "field": "type",
                            "equals": "microsoft.insights/diagnosticSettings"
                          },
                          {
                            "anyOf": [
                              {
                                "field": "name",
                                "contains": "core-"
                              },
                              {
                                "field": "name",
                                "contains": ""
                              }
                            ]
                          }
                        ]
                      },
                      "then": {
                        "effect": "denyAction",
                        "details": {
                          "actionNames": [
                            "delete"
                          ]
                        }
                      }                                
                 },
                "parameters" :{                   
                 },
                 "assignmentparameters" : {
                 },
                 "metadata": {
                  "category": "Custom"
                 }
            },
            {
                "name": "activitylogtocentrallaw",
                "remediation" : true,
                "description": "Configure Azure Activity logs to stream to central  LAW",
                "displayName": "Configure Azure Activity logs to stream to central  LAW",
                "identity": "UserAssigned",
                "userAssignedIdentityId":"/subscriptions/9e3d8089-e29b-4e4b-9203-a49d4a36694d/resourcegroups/test-rg/providers/Microsoft.ManagedIdentity/userAssignedIdentities/cxo-managed-identity",
                "policyRule": {
                    "if": {
                        "field": "type",
                        "equals": "Microsoft.Resources/subscriptions"
                      },
                      "then": {
                        "effect": "[parameters('effect')]",
                        "details": {
                          "type": "Microsoft.Insights/diagnosticSettings",
                          "deploymentScope": "Subscription",
                          "existenceScope": "Subscription",
                          "existenceCondition": {
                            "allOf": [
                              {
                                "field": "Microsoft.Insights/diagnosticSettings/logs.enabled",
                                "equals": "[parameters('logsEnabled')]"
                              },
                              {
                                "field": "Microsoft.Insights/diagnosticSettings/workspaceId",
                                "equals": "[parameters('logAnalytics')]"
                              }
                            ]
                          },
                          "deployment": {
                            "location": "eastus",
                            "properties": {
                              "mode": "incremental",
                              "template": {
                                "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                                "contentVersion": "1.0.0.0",
                                "parameters": {
                                  "logAnalytics": {
                                    "type": "string"
                                  },
                                  "logsEnabled": {
                                    "type": "string"
                                  },
                                  "diagSettingsExportName": {
                                    "type": "string"
                                  }
                                },
                                "variables": {},
                                "resources": [
                                  {
                                    "name": "[parameters('diagSettingsExportName')]",
                                    "type": "Microsoft.Insights/diagnosticSettings",
                                    "apiVersion": "2017-05-01-preview",
                                    "location": "Global",
                                    "properties": {
                                      "workspaceId": "[parameters('logAnalytics')]",
                                      "logs": [
                                        {
                                          "category": "Administrative",
                                          "enabled": "[parameters('logsEnabled')]"
                                        },
                                        {
                                          "category": "Security",
                                          "enabled": "[parameters('logsEnabled')]"
                                        },
                                        {
                                          "category": "ServiceHealth",
                                          "enabled": "[parameters('logsEnabled')]"
                                        },
                                        {
                                          "category": "Alert",
                                          "enabled": "[parameters('logsEnabled')]"
                                        },
                                        {
                                          "category": "Recommendation",
                                          "enabled": "[parameters('logsEnabled')]"
                                        },
                                        {
                                          "category": "Policy",
                                          "enabled": "[parameters('logsEnabled')]"
                                        },
                                        {
                                          "category": "Autoscale",
                                          "enabled": "[parameters('logsEnabled')]"
                                        },
                                        {
                                          "category": "ResourceHealth",
                                          "enabled": "[parameters('logsEnabled')]"
                                        }
                                      ]
                                    }
                                  }
                                ],
                                "outputs": {}
                              },
                              "parameters": {
                                "logAnalytics": {
                                  "value": "[parameters('logAnalytics')]"
                                },
                                "logsEnabled": {
                                  "value": "[parameters('logsEnabled')]"
                                },
                                "diagSettingsExportName": {
                                  "value": "[parameters('diagSettingsExportName')]"
                                }
                              }
                            }
                          },
                          "roleDefinitionIds": [
                            "/providers/microsoft.authorization/roleDefinitions/749f88d5-cbae-40b8-bcfc-e573ddc772fa",
                            "/providers/microsoft.authorization/roleDefinitions/92aaf0da-9dab-42b6-94a3-d43ce8d16293"
                          ]
                        }
                      }                                                     
                 },
                "parameters" :{   
                    "logAnalytics": {
                        "type": "String",
                        "metadata": {
                          "displayName": "Primary Log Analytics workspace",
                          "description": "If this workspace is outside of the scope of the assignment you must manually grant 'Log Analytics Contributor' permissions (or similar) to the policy assignment's principal ID.",
                          "strongType": "omsWorkspace",
                          "assignPermissions": true
                        },
                        "defaultValue": "<log analytics id for diagnostics>"
                      },
                      "effect": {
                        "type": "String",
                        "metadata": {
                          "displayName": "Effect",
                          "description": "Enable or disable the execution of the policy"
                        },
                        "allowedValues": [
                          "DeployIfNotExists",
                          "Disabled"
                        ],
                        "defaultValue": "DeployIfNotExists"
                      },
                      "logsEnabled": {
                        "type": "String",
                        "metadata": {
                          "displayName": "Enable logs",
                          "description": "Whether to enable logs stream to the Log Analytics workspace - True or False"
                        },
                        "allowedValues": [
                          "True",
                          "False"
                        ],
                        "defaultValue": "True"
                      },
                      "diagSettingsExportName": {
                        "type": "String",
                        "metadata": {
                          "displayName": "Diagnostic Settings Export Name",
                          "description": "Name of the Export settings for configuring export to central Log Analytics workspace"
                        },
                        "defaultValue": "StreamLogsToCentralLAW"
                      }                
                 },
                 "assignmentparameters" : {},
                 "metadata": {
                  "category": "CentralizedLogging"
                 }  
            } 
        ]
      },
      "name": {
        "value": "testpolicyset"
      },
      "displayName": {
        "value": "testpolicyset"
      },
      "description": {
        "value": "testingpolicyset"
      },
      "policyCategory": {
        "value": "Monitoring"
      },
      "initativeparams":{
        "value": {
         "logAnalytics" :{
           "type": "string",
           "defaultvalue": "<log analytics id for diagnostics>"
        }
       }
      } ,
      "intiativePolicyAssignmentName" : {
        "value": "CentralLawiniative"
      },
      "userAssignedIdentityId":{
        "value": "<User assigned identity to perform remediation>"
      }
    }
  }
